import { defineEventHandler } from "h3";
import { queryCollection } from "@nuxt/content/server";
import manifest from "#content/manifest";
export default defineEventHandler(async (e) => {
  const collections = [];
  for (const collection in manifest) {
    if (manifest[collection].fields.sitemap) {
      collections.push(collection);
    }
  }
  const contentList = [];
  for (const collection of collections) {
    contentList.push(
      // @ts-expect-error dynamic collection name
      queryCollection(e, collection).select("path", "sitemap").where("path", "IS NOT NULL").where("sitemap", "IS NOT NULL").all()
    );
  }
  const results = await Promise.all(contentList);
  return results.flatMap(
    (entries) => entries.filter((c) => c.sitemap !== false && c.path).map((c) => ({
      loc: c.path,
      ...typeof c.sitemap === "object" ? c.sitemap : {}
    }))
  ).filter(Boolean);
});
